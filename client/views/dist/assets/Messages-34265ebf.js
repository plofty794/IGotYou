import{M as H,j as n,K as _,u as D,k as e}from"./index-01afcc0a.js";import{u as g,al as k,m as v,a7 as z,a4 as G,L as N,af as K,ag as L,ah as Q,a8 as x,a9 as m,aa as h,am as O,an as W,B as C,ao as J,ap as X,aq as Y,ar as Z,as as ee,at as se,au as te,ab as p,S as ae,ad as ne,V as f,ac as re}from"./App-0ab66eea.js";import{L as ie}from"./ListingsLoader-0c06c4a6.js";function le(){const{toast:a}=H(),{conversationID:r}=g(),{socket:c}=n.useContext(_),u=D();return k({mutationFn:async({content:d,receiverName:l})=>await v.post(`/api/users/current-user/conversations/send-message/${r}`,{content:d,receiverName:l}),onSuccess(d){c==null||c.emit("chat-message",d.data),u.invalidateQueries({queryKey:["conversations"],refetchType:"all"}),u.invalidateQueries({queryKey:["conversation",r]})},onError(d){a({title:"Oops! Message not sent.",description:d.response.data.error,variant:"destructive"})}})}function oe(){const{conversationId:a}=g(),r=D();return k({mutationFn:async c=>await v.delete(`/api/users/current-user/conversations/delete/${c}`),onSuccess:()=>{r.removeQueries({queryKey:["conversation",a]})}})}function ce(){const{conversationID:a}=g();return z({queryKey:["conversation",a],queryFn:async()=>await v.get(`/api/users/current-user/conversations/${a}`),enabled:a!=null})}function me(){var T,F,q,S,E,M,I;const a=n.useRef(null),{conversationID:r}=g(),c=G(),u=le(),{mutate:d}=oe(),l=D(),{socket:j}=n.useContext(_),{data:t,isPending:$}=ce(),[y,P]=n.useState([]),[o,U]=n.useState([]),[b,A]=n.useState(""),[w,R]=n.useState();n.useEffect(()=>{var s;t!=null&&t.data.conversation.length&&((s=t==null?void 0:t.data.conversation)==null||s.map(i=>U(i.participants.filter(B=>B._id!==t.data.currentUserID)))),R(t==null?void 0:t.data.conversation),t==null||t.data.conversation.map(i=>P(i.messages)),setTimeout(()=>{var i;return(i=a.current)==null?void 0:i.scrollIntoView({behavior:"instant"})},0)},[t==null?void 0:t.data.conversation,t==null?void 0:t.data.currentUserID]),n.useEffect(()=>{var s;u.isSuccess&&((s=a.current)==null||s.scrollIntoView({behavior:"smooth"}))},[u.isSuccess]);async function V(s){await v.patch(`/api/users/current-user/conversations/read-message/${s}`,{read:!0}),l.invalidateQueries({queryKey:["conversation",s],refetchType:"all"}),l.invalidateQueries({queryKey:["conversations"],refetchType:"all"}),l.invalidateQueries({queryKey:["guest-notifications"],refetchType:"all"})}return n.useEffect(()=>{j==null||j.on("receive-message",()=>{l.invalidateQueries({queryKey:["conversation",r],refetchType:"all"}),l.invalidateQueries({queryKey:["conversations"],refetchType:"all"})})},[r,l,j]),e.jsx("div",{className:"px-8 py-6",children:$?e.jsx(ie,{}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 flex w-full items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{to:`/users/visit/show/${(T=o[0])==null?void 0:T._id}`,children:e.jsxs(K,{children:[e.jsx(L,{className:"object-cover",src:(F=o[0])==null?void 0:F.photoUrl}),e.jsx(Q,{children:"CN"})]})}),e.jsx("span",{className:"text-lg font-semibold",children:(q=o[0])==null?void 0:q.username})]}),e.jsx(x,{children:e.jsxs(m,{children:[e.jsx(h,{children:e.jsxs(O,{children:[e.jsx(W,{asChild:!0,children:e.jsx(C,{className:"p-2",variant:"destructive",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"white",className:"h-6 w-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"})})})}),e.jsxs(J,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Are you absolutely sure?"}),e.jsxs(Z,{className:"font-semibold text-gray-600",children:["This action cannot be undone. This will"," ",e.jsx("span",{className:"font-bold text-red-600 underline",children:"permanently delete"})," ","this conversation from our servers."]})]}),e.jsxs(ee,{children:[e.jsx(se,{className:"rounded-full",children:"Cancel"}),e.jsx(te,{onClick:()=>{r&&d(r),setTimeout(()=>{c("/messages",{replace:!0}),document.location.reload()},600)},className:"rounded-full bg-gray-950",children:"Continue"})]})]})]})}),e.jsx(p,{children:e.jsx("p",{children:"Delete chat"})})]})})]}),e.jsx(ae,{}),e.jsxs(ne,{className:"relative mt-2 h-[65vh] rounded-md border bg-[#F5F5F5] p-6",children:[e.jsxs("div",{className:"mx-auto flex w-max flex-col items-center justify-center gap-2",children:[e.jsx(N,{to:`/users/visit/show/${(S=o[0])==null?void 0:S._id}`,children:e.jsxs(K,{className:"h-24 w-24",children:[e.jsx(L,{className:"object-cover",src:(E=o[0])==null?void 0:E.photoUrl}),e.jsx(Q,{children:"CN"})]})}),e.jsx("span",{className:"text-xl font-semibold",children:(M=o[0])==null?void 0:M.username}),e.jsx(N,{to:`/users/visit/show/${(I=o[0])==null?void 0:I._id}`,children:e.jsx(C,{className:"rounded-full bg-zinc-900 text-xs",children:"View profile"})})]}),e.jsx("div",{className:"mb-10 mt-4 flex h-max flex-col gap-2 p-4",children:y.map((s,i)=>s.senderID._id===(t==null?void 0:t.data.currentUserID)?e.jsx(e.Fragment,{children:y.length==i+1?e.jsx("div",{ref:a,className:"ml-auto w-max rounded-full bg-blue-500 px-4 py-2",children:e.jsx(x,{children:e.jsxs(m,{children:[e.jsxs(h,{children:[" ",e.jsx("span",{className:"text-sm font-semibold text-white",children:s.content},s._id)]}),e.jsx(p,{children:e.jsx("p",{children:f(new Date(s.createdAt),"p")})})]})})}):e.jsx("div",{className:"ml-auto w-max rounded-full  bg-blue-500 px-4 py-2",children:e.jsx(x,{children:e.jsxs(m,{children:[e.jsxs(h,{children:[" ",e.jsx("span",{className:"text-sm font-semibold text-white",children:s.content},s._id)]}),e.jsx(p,{children:e.jsx("p",{children:f(new Date(s.createdAt),"p")})})]})})})}):e.jsx(e.Fragment,{children:y.length==i+1?e.jsx("div",{ref:a,className:"mr-auto w-max rounded-full bg-[#E5E4E9] px-4 py-2",children:e.jsx(x,{children:e.jsxs(m,{children:[e.jsxs(h,{children:[" ",e.jsx("span",{className:"text-sm font-semibold",children:s.content},s._id)]}),e.jsx(p,{children:e.jsx("p",{children:f(new Date(s.createdAt),"p")})})]})})}):e.jsx("div",{className:"mr-auto w-max rounded-full bg-[#E5E4E9] px-4 py-2",children:e.jsx(x,{children:e.jsxs(m,{children:[e.jsxs(h,{children:[" ",e.jsx("span",{className:"text-sm font-semibold",children:s.content},s._id)]}),e.jsx(p,{children:e.jsx("p",{children:f(new Date(s.createdAt),"p")})})]})})})}))}),e.jsx("form",{onSubmit:s=>{s.preventDefault(),A(""),u.mutate({content:b,receiverName:o[0].username})},children:e.jsxs("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-between gap-2 bg-[#F5F5F5] p-2",children:[e.jsx(re,{value:b,onChange:s=>A(s.target.value),placeholder:"Message...",onFocus:async()=>{var s;return w!=null&&!((s=w[0])!=null&&s.lastMessage.read)&&await V(w[0].lastMessage._id)},className:"w-full rounded-full bg-white p-5 font-medium",spellCheck:"true"}),e.jsx(C,{disabled:!b,className:"rounded-full bg-gray-950 p-6 text-lg",children:"Send"})]})})]})]})})}export{me as default};
